{% extends "ui/base.html" %}
{% load page_url %}

{% block title %}{{user.username}}{% endblock %}
{% block head %}
<script type="text/javascript" src="{{MEDIA_URL}}js/tjpzoom/tjpzoom.js"></script>
<script type="text/javascript">
	function renderDocumentPanel(documentJsonText) {
		try {
			documentObject = YAHOO.lang.JSON.parse(documentJsonText);
		}
		catch (e) {
			YAHOO.log('JSON parsing error ' + e)
		}
		documentDataSource = new YAHOO.util.DataSource(documentObject.pages);
		documentDataSource.responseType = YAHOO.util.DataSource.TYPE_JSARRAY;
		documentDataSource.responseSchema = {fields: ['page_url']};
		
		colDefs = [{key:"page_url", label:"", formatter:this.imgFormatter}];
		documentDataTable = new YAHOO.widget.DataTable("document-content", colDefs, documentDataSource);
		YAHOO.log('documentDataSource is ' + documentDataTable);
	
		document.getElementById('document-title').innerHTML = documentObject.title
		document.getElementById('document-panel').setAttribute('style', 'visibility:visible;');
	}
	
    function onClickDeletePage(p_oEvent) 
	{
        YAHOO.log("clicked " + this.get("id"), "info", "donomo");
		var callback =
		{
		  success: function(o) {
		  			YAHOO.log("successul DELETE: " + o.responseText);
					
				},
		  	failure: function(o) {
		  			YAHOO.log("DELETE failed");
				}
		}
		var transaction = YAHOO.util.Connect.asyncRequest('DELETE', '/page/{{pageview_page_id}}', callback, "title=document+title"); // http://developer.yahoo.com/yui/connection/: (HEAD, PUT and DELETE may not be supported by all A-Grade browsers ).
    }

    function onClickAddPage(p_oEvent) 
	{
		function onPostFailed(o) {
		  		YAHOO.log("POST failed");
		}
		function onPostPage(o) {
  			this.imgFormatter = function(elCell, oRecord, oColumn, oData) {
				elCell.innerHTML = '<img src="' + oData + '" /> ' + oData;
			}
			
  			YAHOO.log("successul POST: " + o.responseText);
						
			renderDocumentPanel(o.responseText);
		}
		function onPostDocument(o) {
			d = o.getResponseHeader['Location']
			YAHOO.util.Cookie.set("currentDocument", d)
			bindPageToDocument(d, id)
		}
		function bindPageToDocument(doc, id) {
			YAHOO.util.Connect.asyncRequest('POST', doc, {success: onPostPage, failure: onPostFailed}, "page_id=" + id + "&viewtype=thumbnail100");	
		}

		var id = this.get("id").split(".")[0];
		
		currentDocument = YAHOO.util.Cookie.get("currentDocument");
		if (currentDocument == undefined) {
	 		// show first, then start talking to the server		
			document.getElementById('document-panel').setAttribute('style', 'visibility:visible;');
	
			var searchQuery = document.getElementById("search-query").value;
			if (searchQuery == "") {
				searchQuery = "Untitled Document";
			}
			YAHOO.util.Connect.asyncRequest('POST', '/doc/', {success: onPostDocument, failure: onPostFailed}, "title="+searchQuery); 		
		} else {
			bindPageToDocument(currentDocument, id);
		}
	}
</script>



{% endblock %}
{% block body %}
   <div id="hd"><a href="/">Home</a> | <a href="/account/signout/?next=/">Log Out</a></div>
	<div id="bd">
		<div class="yui-g">
			<form action="/store/search/" name=f>
	            <table cellpadding=0 cellspacing=0>
	                <tr valign=top>
	                    <td align=center nowrap>
	                        <input maxlength=2048 name=q size=55 title="Search" value="{{search_query}}" id="search-query">
	                        <input name=btn_search type=submit value="Search">
	                    </td>
	                </tr>
	            </table>
	        </form>
			{% if document %}
				Get as PDF <a href="/doc/{{document.id}}/?format=application/pdf"><img src="{{MEDIA_URL}}img/pdf_40x40.gif"/></a>
			{% endif %}
		</div>
		<div class="yui-ge">
		    <div class="yui-u first">
                {% for id in page_ids %}
					<script type="text/javascript">
						YAHOO.util.Event.onContentReady("{{id}}.container-page", 
							function() {
								new YAHOO.widget.Button({
									id : "{{id}}.pushbutton-add-page", 
									container : "{{id}}.container-add-page", 
									label: "Add this page to document", 
									onclick: { fn: onClickAddPage }
								});
								new YAHOO.widget.Button({
									id : "{{id}}.pushbutton-delete-page", 
									container : "{{id}}.container-delete-page", 
									label: "Remove this page from document", 
									onclick: { fn: onClickAddPage }
								});
							}
						); 
					</script>
					<div id = "{{id}}.container-page" class="yui-gc">
					    <div class="yui-u first">
			                <div>
								{% page_url id jpeg-thumbnail-200 as page_thumb %}
								{% page_url id jpeg-original as page_image %}
								<img src="{{page_image}}" width="100%" onmouseover="TJPzoom(this);"/>
			                </div>
					    </div>
					    <div class="yui-u">
							<form>
{% comment %}

							<table><tbody>
							<tr>
							<td>tags</td>
							<td><input id="tags" name="tags" value="not yet implemented" size="20" type="text" autocomplete="off" /></td>
							</tr>
							</tbody>
							</table>
							</form>
{% endcomment %}
							Get as PDF <a href="/page/{{id}}/?format=application/pdf"><img src="{{MEDIA_URL}}img/pdf_40x40.gif"/></a><br/>
							
							<span id="{{id}}.container-add-page"/>
							<br/>
							<span id="{{id}}.container-delete-page"/>
						</div>
					</div>
                {% endfor %}
			</div>
		    <div class="yui-u" id="document-editor">
				<script type="text/javascript">
			        function getOrCreateDocument() {
			            YAHOO.log("getOrCreateNewDocument");
						
						currentDocument = YAHOO.util.Cookie.get('currentDocument');
						if (currentDocument == undefined) {
							var callback =
							{
							  success: function(o) {
							  	currentDocument = o.getResponseHeader['Location'];
							  	YAHOO.log("successul POST: " + currentDocument);
								
								YAHOO.util.Cookie.set("currentDocument", currentDocument)
								},
							  failure: function(o) {YAHOO.log("POST failed");}
							}
							
							var searchQuery = document.getElementById("search-query").value;
							if (searchQuery == "") {
								searchQuery = "Untitled Document";
							}
							YAHOO.log('searchQuery is ' + searchQuery)
							YAHOO.util.Connect.asyncRequest('POST', '/doc/', callback, "title="+searchQuery); 
						}
						return currentDocument
			        }
					
					function onClickCloseDocument(p_oEvent) {
						YAHOO.util.Cookie.remove("currentDocument");
						document.getElementById('document-panel').setAttribute('style', 'visibility:hidden;');
					}

					YAHOO.util.Event.onContentReady("document-panel", 
						function() { 
							new YAHOO.widget.Button({
								id : "pushbutton-close-document", 
								container : "container-close-document", 
								label: "Document done", 
								onclick: { fn: onClickCloseDocument }
							});
							currentDocument = YAHOO.util.Cookie.get('currentDocument');
							if (currentDocument == undefined) {
								document.getElementById('document-panel').setAttribute('style', 'visibility:hidden;');
							} else {
								YAHOO.util.Connect.asyncRequest('GET', currentDocument+ "?format=application/json&viewtype=thumbnail100", {success: function(o) {renderDocumentPanel(o.responseText);}});
							}
						}
					);
				</script>
		    	<div id="document-panel" style="visibility:hidden"> 
					<span id="container-close-document"/><span id="document-title">doc title goes here</span>
					<div id="document-content">doc content goes here</div>
				</div>
			</div>
	</div>

	<!--- LOGGING --->	
		<div style="visibility:hidden;" class="yui-log yui-log-container">
		    <div class="yui-log-hd">
		        <div class="yui-log-btns">
		            <input type="button" class="yui-log-button" value="Collapse">
		        </div>
		        <h4>Logger Console</h4>
		    </div>
		    <div class="yui-log-bd">
		        <pre class="yui-log-verbose">
		            <p><span class="[category]">CATEGORY</span> Message.</p>
		        </pre>
		        ...
		    </div>
		    <div class="yui-log-ft">
		        <div class="yui-log-btns">
		            <input type="button" class="yui-log-button" value="Pause">
		            <input type="button" class="yui-log-button" value="Clear">
		        </div>
		        <div class="yui-log-categoryfilters">
		            <span class="yui-log-filtergrp">
		                <input type="checkbox" class="yui-log-filter-[category]">
		                <label class="[category]">category</label>
		            </span>
		            ...
		        </div>
		        <div class="yui-log-sourcefilters">
		            <span class="yui-log-filtergrp">
		                <input type="checkbox" class="yui-log-filter[source]">
		                <label class="[source]">source</label>
		            </span>
		            ...
		        </div>
		</div>
	</div>
		<script type="text/javascript">
			var myLogReader = new YAHOO.widget.LogReader("logger");
		</script>
	<!--- LOGGING END --->
	
{% endblock %}
